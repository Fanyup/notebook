## å¯¼å…¥é»‘é©¬ç‚¹è¯„é¡¹ç›®

`jdbc:mysql://localhost:3306/hmdp?characterEncoding=utf8&useUnicode=true&useSSL=false&autoReconnect=true`



![chrome_oLkEjWLq4c.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_oLkEjWLq4c.png)

![idea64_lbSqqdPOrB.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_lbSqqdPOrB.png)

åœ°å€ğŸ‘‰`E:\Tools\nginx-1.18.0`

åœ¨è¯¥ç›®å½•ä¸‹æ‰€åœ¨çª—å£è¾“å…¥cmd,æ‰§è¡Œå‘½ä»¤`start nginx.exe`ï¼Œå³å¯å¯åŠ¨ã€‚

æˆ‘ä»¬é»˜è®¤å‰ç«¯è®¿é—®æ¥å£8080ï¼Œåç«¯8081.

### IDEç‚¹å‡»serviceæ·»åŠ springbootå¯åŠ¨æ¨¡å—

å¦‚æœä¸‹æ–¹æ æ²¡æœ‰Servicesçš„åŒå­¦ç‚¹å‡»IDEAå·¦ä¸Šè§’View->Tools Windows->Servicesæ·»åŠ ã€‚

åœ¨è¿™ä¸€æ­¥ä¸­æˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå¯¼å…¥é¡¹ç›®åIDEæ— æ³•è¯†åˆ«åˆ°springbootï¼ŒæŸ¥çœ‹åå‘ç°æˆ‘æ ¹æœ¬æ²¡æœ‰ç”¨mavenå¯¼å…¥ï¼äºæ˜¯æˆ‘é‡æ–°å°†é¡¹ç›®å¯¼å…¥å¹¶åŠ è½½å¯åŠ¨Mavenåä¸€åˆ‡éƒ½å¥½äº†ã€‚

## åŸºäºä¼ ç»ŸSessionå®ç°ç™»å½•

### ä¸šåŠ¡æµç¨‹

![chrome_gQvt2fYV9H.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_gQvt2fYV9H.png)

æäº¤éªŒè¯ç ï¼Œæ ¡éªŒï¼Œç”ŸæˆéªŒè¯ç å¹¶ä¿å­˜åœ¨æœ¬åœ°(session)ï¼Œä¸º**ç”¨æˆ·è¾“å…¥éªŒè¯ç **åšéªŒè¯å‡†å¤‡ã€‚ä¸ä¸€è‡´åˆ™æ‹’ç»ï¼Œä¸€è‡´éªŒè¯ç åˆ™ä¸‹ä¸€æ­¥**æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯**ï¼ŒæŸ¥è¯¢æ•°æ®åº“**ç”¨æˆ·æ˜¯å¦å­˜åœ¨**ï¼Œä¸å­˜åœ¨åˆ›å»ºæ–°ç”¨æˆ·å†™å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œè‹¥å­˜åœ¨ï¼Œå°†ç”¨æˆ·ä¿å­˜åœ¨sessionã€‚

ä»¥åè®¿é—®å…³é”®ä¸šåŠ¡éœ€è¦æ ¡éªŒç™»å½•çŠ¶æ€ã€‚å¦‚ä½•è¿›è¡Œsessionæ ¡éªŒï¼Ÿ

æˆ‘ä»¬çŸ¥é“**sessionæ˜¯åŸºäºcookieçš„**ï¼Œ**æ¯ä¸€ä¸ªsessionéƒ½ä¼šæœ‰ä¸€ä¸ªsessionIDä¿å­˜åœ¨æµè§ˆå™¨å½“ä¸­**ï¼Œå½“ç”¨æˆ·è¯·æ±‚è®¿é—®æ—¶ä¸€å®šä¼šæºå¸¦ä»–çš„cookieï¼Œciookieé‡Œå°±æœ‰å®ƒçš„sessionIDï¼Œè¿›è€Œå¸®åŠ©æˆ‘ä»¬ä»sessionä¸­è·å–ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼ˆæ˜¯å¦ç™»å½•è¿‡ï¼‰ã€‚

ä¸€èˆ¬æˆ‘ä»¬åç»­æ“ä½œä¼šç”¨åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†å…¶ç¼“å­˜åˆ°æœ¬åœ°ã€‚ä¸€èˆ¬æˆ‘ä»¬å°†ç”¨æˆ·ä¿å­˜åˆ°**ThreadLocal**ä¸­ã€‚ï¼ˆçº¿ç¨‹åŸŸå¯¹è±¡ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾å¾®æœåŠ¡ï¼Œéƒ½å°†æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼‰ã€‚

### ä¸ç”¨ThreadLocalå°†å‡ºç°çš„é—®é¢˜

å¦‚æœåªæ˜¯å°†ä¿¡æ¯ä¿å­˜åœ¨æœ¬åœ°å˜é‡ï¼Œå¯èƒ½ä¼šå‡ºç°å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹çš„å®‰å…¨é—®é¢˜ã€‚è€ŒThreadLocalå°†ä¼šæŠŠæ•°æ®ä¿å­˜åœ¨**æ¯ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨**ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰å¹²æ‰°ã€‚

### åŠŸèƒ½ä¸€ï¼šå‘é€çŸ­ä¿¡éªŒè¯ç 

#### æ•´ä½“æµç¨‹ï¼ˆå¤§æ¡†æ¶ï¼‰

ç¼–å†™ä¸€ä¸ªä¸šåŠ¡çš„æ¥å£ï¼Œå»å¤„ç†å‰ç«¯æäº¤çš„è¯·æ±‚ï¼ˆä¼ è¿‡æ¥çš„æ‰‹æœºå·ï¼‰

![chrome_Ab1Oj5juc5.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_Ab1Oj5juc5.png)

æ‰¾åˆ°Controllerå±‚ï¼Œåˆ›å»ºserviceå±‚æœåŠ¡ï¼ˆæä¾›æ–¹æ³•æ¥å£ï¼‰ï¼ˆAlt+Enterå¿«é€Ÿåˆ›å»ºï¼‰

![idea64_jNMnqZa51a.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_jNMnqZa51a.png)

é€šè¿‡åˆ›å»ºæ¥å£æ–¹æ³•ï¼Œæ‰¾åˆ°æœåŠ¡æ¥å£ï¼Œè¿›ä¸€æ­¥æŸ¥æ‰¾åˆ°å®ƒçš„**å®ç°ç±»**ã€‚ç»§ç»­alt+enterå®ç°å¯¹åº”æ–¹æ³•ã€‚

![ShareX_MXQgtAVCvn.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/ShareX_MXQgtAVCvn.png)

å®ƒæ˜¯ä¸€ä¸ªé€šç”¨çš„ç»“æœå¯¹è±¡ğŸ‘‡ï¼ˆç‚¹å¼€è¯¦æƒ…ï¼‰

![idea64_4rDdotnq0L.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_4rDdotnq0L.png)

å› æ­¤è¿™é‡Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨Resulté‡Œçš„é™æ€æ–¹æ³•ï¼Œok~

![idea64_TohaFFAXzS.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_TohaFFAXzS.png)

#### å†…éƒ¨ç»†èŠ‚é€ä¸€å®ç°

```java
@Override
    public Result sendCode(String phone, HttpSession session) {
        // 1.æ ¡éªŒæ‰‹æœºå·
        if (RegexUtils.isPhoneInvalid(phone)) {
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");
        }
        // 3.ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç 
        String code = RandomUtil.randomNumbers(6);
        // 4.å…ˆä¿å­˜åˆ°session
        session.setAttribute("code",code);
        // 5.ï¼ˆæ¨¡æ‹Ÿï¼‰åœ¨å‘é€éªŒéªŒè¯ç 
        log.debug("å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç :{}", code);
        // 6. è¿”å›OK
        return Result.ok();
    }
```

ä¸€èˆ¬æ ¡éªŒæ‰‹æœºå·ï¼ˆæ˜¯å¦ç¬¦åˆä½æ•°ï¼‰ä¼šé‡‡ç”¨æ­£åˆ™è¡¨è¾¾å¼(Regex)ï¼Œ**utilsåŒ…**ä¸‹å·²ç»å‡†å¤‡å¥½äº†æ­£åˆ™è¡¨è¾¾å¼çš„`RegexPatterns` å·¥å…·ç±»ï¼Œä¸`RegexUtils`å·¥å…·ç±»ã€‚

**éšæœºç”Ÿæˆå™¨**ç”Ÿæˆå…­ä½éªŒè¯ç ã€‚è¿™é‡Œç”¨åˆ°æˆ‘ä»¬å¼•å…¥ä¾èµ–çš„**hutoolå·¥å…·ç±»**ï¼ˆç™¾å®ç®±ï¼Œä»€ä¹ˆéƒ½æœ‰ï¼‰ä¸­çš„**RandomUtil**

æ¥ä¸‹æ¥å°±ç®€å•äº†ï¼Œä¿å­˜åˆ°sessionçš„apiã€‚

å‘é€éªŒè¯ç éœ€è¦å»è°ƒç”¨ç¬¬ä¸‰æ–¹å¹³å°ï¼ˆé˜¿é‡Œäº‘e.gï¼‰ï¼Œæš‚æ—¶ç•¥è¿‡ï¼Œç”¨`@Slf4j`å†™ä¸ªå‡çš„ã€‚

![chrome_mAbKdChFmg.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_mAbKdChFmg.png)

é‡å¯åå°±OKå™œã€‚

æ­¤æ—¶ç‚¹å¼€åå°å¯ä»¥å‘ç°å†™çš„æ—¥å¿—log.debugä¼šæœ‰åé¦ˆç»“æœ~

![idea64_ApFBaNbfp7.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_ApFBaNbfp7.png)

#### åŠŸèƒ½äºŒï¼šç™»å½•è·³è½¬

![chrome_kmHqTCofgL.gif](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_kmHqTCofgL.gif)

æˆ‘ä»¬åœ¨ç‚¹å‡»ç™»å½•æŒ‰é’®åå¯ä»¥åœ¨F12æ§åˆ¶å°çœ‹å‘é€çš„è¯·æ±‚ä¿¡æ¯ï¼Œä»¥åŠå¯¹åº”å‚æ•°ï¼ˆjsonæ ¼å¼)ã€‚

#### å¤ä¹ ä¸€ä¸‹æ³¨è§£ä¸ç¼©å†™çŸ¥è¯†

Oä¸€èˆ¬ä»£è¡¨Objectï¼ˆå¯¹è±¡çš„æ„æ€ï¼‰

- **POJO**ï¼šPlain Ordinary Java Objectï¼ˆç®€å•Javaå¯¹è±¡ã€åŸç”Ÿå¯¹è±¡ï¼‰ï¼Œ**åªåŒ…å«ç®€å•çš„get/setæ–¹æ³•**

- VOï¼šView Objecetï¼ˆè§†å›¾å¯¹è±¡ï¼‰ï¼Œå¦‚htmlã€jsp

- **DTO**ï¼šData Transfer Objectï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰ï¼Œå¹¶**ä¸åœ¨é¡µé¢ä¸Šåšå±•ç¤ºï¼Œåªæ˜¯ä¼ è¾“ç”¨**

- ORMï¼šObject Relationship Mappingï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰

- DMï¼šDomain Modelï¼ˆé¢†åŸŸæ¨¡å‹ï¼‰ï¼Œæ¯”å¦‚é“¶è¡Œã€ä¿é™©ã€ç”µå•†ã€ç‰©æµã€åŒ»ç–—å°±æ˜¯é¢†

- DDDï¼šDomain Driven Designï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰

- **DAO**ï¼šData Access Objectï¼ˆ**æ•°æ®è®¿é—®å¯¹è±¡**ï¼‰

- DOï¼šData Objectï¼ˆæ•°æ®å¯¹è±¡ï¼‰

- BOï¼šBusiness Objectï¼Œä¸šåŠ¡å¯¹è±¡ã€‚

- NPEï¼šjava.lang.NullPointerExceptionçš„ç®€ç§°ã€‚

- OOMï¼šOut Of Memoryï¼Œå†…å­˜æº¢å‡ºã€‚

- ReDOSï¼šRegular expression Denial of Serviceï¼Œæ­£åˆ™è¡¨è¾¾å¼æ‹’ç»æœåŠ¡æ”»å‡»ã€‚

è¿™ä¸€æ­¥ä¸­å±æ€§ä¼ é€’ç”¨åˆ°äº†requestæ³¨è§£ã€‚å‰ç«¯æäº¤çš„æ˜¯ä¸€ä¸ªjsoné£æ ¼ï¼Œåå°æ¥æ”¶å°±å¿…é¡»è¦ç”¨åˆ°`@RequestBody`æ³¨è§£ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªDTOå®ä½“ç±»å¯¹è±¡ã€‚

#### ä¸ºä»€ä¹ˆåå‘æ ¡éªŒï¼Ÿè€Œä¸ç”¨æ­£å‘æ ¡éªŒ

![idea64_q6GNWHUZgm.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_q6GNWHUZgm.png)

ä¸éœ€è¦ifåµŒå¥—ï¼Œå½¢æˆé’»çŸ³å‹ï¼ˆè±å½¢ä»£ç ï¼‰

### ç»†èŠ‚ï¼šquery

![idea64_Ws9DWudi2b.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_Ws9DWudi2b.png)

è¦ç”¨åˆ°sqlè¯­å¥ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨äº†mybatis-plusçš„å½¢å¼ã€‚è€Œè¿™ä¸ªqueryæ–¹æ³•å®é™…ä¸Šæ˜¯æ¥å£implå®ç°ç±»è‡ªå¸¦çš„ï¼Œå› ä¸ºå®ƒç»§æ‰¿è‡ªServiceImplï¼Œè€Œåè€…æ˜¯ç”±mybatis-plusæä¾›çš„ã€‚å®ƒèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å®ç°**å•è¡¨çš„CRUD**ã€‚

![idea64_851A5hPmRC.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_851A5hPmRC.png)

```java
@Override
    public Result login(LoginFormDTO loginForm, HttpSession session) {
        // æ¯ä¸ªè¯·æ±‚éƒ½è¦åšç‹¬ç«‹çš„æ ¡éªŒ
        // 1.æ ¡éªŒæ‰‹æœºå·
        String phone = loginForm.getPhone();
        if (RegexUtils.isPhoneInvalid(phone)) {
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");
        }
        // 2.æ ¡éªŒéªŒè¯ç 
        Object cacheCode = session.getAttribute("code");  //sessioné‡Œçš„code
        String code = loginForm.getCode();                  //å‰ç«¯çš„code
        if(cacheCode == null || !cacheCode.toString().equals(code)){
            // 3.ä¸ä¸€è‡´ï¼ŒæŠ¥é”™
            return Result.fail("éªŒè¯ç é”™è¯¯");
        }
        // 4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·(æ•°æ®åº“æŸ¥) select * from tb_user where phone = ?
        User user = query().eq("phone", phone).one();
        // 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        if (user == null) {
            // 6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜
            user = createUserWithPhone(phone);
        }
        // 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­
        session.setAttribute("user", user);
        return Result.ok();
    }

    private User createUserWithPhone(String phone) {
        // 1.åˆ›å»ºç”¨æˆ·
        User user = new User();
        user.setPhone(phone);
        user.setNickName(USER_NICK_NAME_PREFIX + RandomUtil.randomString(10));
        // 2.ä¿å­˜ç”¨æˆ·
        save(user);
        return  user;
    }
```

#### å‰ç«¯å¯åŠ¨ä¸äº†é—®é¢˜

å› ä¸ºæ˜¯ç¬¬äºŒå¤©å†ç»§ç»­åšè¿™ä¸ªé¡¹ç›®ï¼Œæ£€æŸ¥åå‘ç°åŸæ¥æ˜¯å¿˜äº†å¯åŠ¨nginxã€‚å‰åç«¯åˆ†ç¦»æ¨¡å¼ã€‚å†é‡å‘ä¸€ä¸‹è¿™å¼ æ€»è§ˆå›¾ğŸ‘‡å®ƒæ˜¯é€šè¿‡nginxæœåŠ¡å™¨å†ç»Ÿä¸€åˆ°çŒ«ï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Œä»¥çŒ«ä¸ºå¥‘æœºè¿æ¥åç«¯æ•°æ®åº“ï¼ˆå¼€å‘é˜¶æ®µç”¨IDEAæ‰“å¼€ï¼‰ã€‚

![chrome_mZHizI50Iq.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_mZHizI50Iq.png)

### åŠŸèƒ½ä¸‰ï¼šç™»å½•éªŒè¯

æŸ¥è¯¢å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·è¯·æ±‚ä¼šå¸¦ä¸ŠCookieï¼ˆé‡Œé¢åŒ…å«SessionID)

### å­˜åœ¨çš„æ½œåœ¨é—®é¢˜

éšç€åç»­ä¸šåŠ¡å¼€å‘éƒ½éœ€è¦è¿›è¡Œç”¨æˆ·éªŒè¯ã€‚æ¯ä¸€ä¸ªXXXControlleréƒ½å†™éå¸¸ç¹å†—ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨SpringMVCæä¾›çš„**æ‹¦æˆªå™¨**å»ç®€åŒ–æ­¥éª¤ã€‚ä½†æ‹¦æˆªå™¨åŒæ—¶æœ‰é—®é¢˜ï¼Œåç»­Controlleréœ€è¦ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒæ—¶è€ƒè™‘çº¿ç¨‹é—®é¢˜ã€‚è¿™æ—¶åˆåŒå’å•ç”¨åˆ°äº†æˆ‘ä»¬çš„**ThreadLocal**!æ˜¯ä¸æ˜¯éå¸¸ç†Ÿæ‚‰å‘¢ï¼Œå†ç‘å‰å¤–å–ä¸­åŒæ ·ä½¿ç”¨åˆ°äº†å®ƒæ¥ä¿å­˜æ‹¦æˆªå™¨ä¸­çš„ç”¨æˆ·idä¿¡æ¯ã€‚

ThreadLocalæ˜¯ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œæ¯ä¸€ä¸ªè¿›å…¥åˆ°çŒ«çš„è¯·æ±‚éƒ½æ˜¯**ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹**ã€‚å°†æ¥ThreadLocalä¼šåœ¨**çº¿ç¨‹å†…å•ç‹¬å¼€è¾Ÿä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œå»ä¿å­˜å¯¹åº”ç”¨æˆ·**ã€‚æ¯ä¸ªçº¿ç¨‹ç›¸äº’ä¸å¹²æ‰°ã€‚

![idea64_jUQ0OW0hJj.png](C:\Users\up\AppData\Roaming\marktext\images\39e5ce9aa5ad7327c13da91758abced7f257c6b1.png)

å®ç°è¯¥æ¥å£ï¼Œé‡å†™é‡Œé¢ä¸¤ä¸ªæ–¹æ³•ã€‚

å¿«æ·é”®`Ctrl+i`å¿«é€Ÿ**é‡å†™æ–¹æ³•**ã€‚

ç¬¬äº”æ­¥ä¸­çš„utilså·¥å…·åŒ…ä¸‹æœ‰ä¸€ä¸ªUserHolderå·¥å…·ç±»ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªThreadLocalçš„å¸¸é‡ï¼Œæ³›å‹ä¸ºUserã€‚é‡Œé¢å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆå› ä¸ºæ˜¯é™æ€çš„ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚

å°ç»†èŠ‚ğŸ‘‡å¯¹å…¶è¿›è¡Œå¼ºè½¬ï¼š

![idea64_TaaLybMG60.gif](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_TaaLybMG60.gif)

#### ç¼–å†™æ‹¦æˆªå™¨ï¼ˆæœªç”Ÿæ•ˆï¼‰

```java
public class LoginInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 1.è·å–session
        HttpSession session = request.getSession();
        // 2.è·å–sessionä¸­çš„ç”¨æˆ·
        Object user = session.getAttribute("user");
        // 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        if (user == null) {
            // 4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆª;è¿”å›401çŠ¶æ€ç ï¼šæœªæˆæƒ
            response.setStatus(401);
            return false;
        }
        // 5.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal
        UserHolder.saveUser((UserDTO) user);
        // 6.æ”¾è¡Œ
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        //ç§»é™¤ç”¨æˆ·
        UserHolder.removeUser();
    }
}
```

#### é…ç½®æ‹¦æˆªå™¨

åœ¨configï¼ˆé…ç½®ï¼‰åŒ…ä¸‹ç¼–å†™MvcConfigç±»ï¼Œé¦–å…ˆè®©å®ƒå»å»å®ç°WebMvcConfigurerã€‚é‡å†™addInterceptorsæ–¹æ³•ï¼ˆæ·»åŠ æ‹¦æˆªå™¨ï¼‰ã€‚

`InterceptorRegistry`æ˜¯æ‹¦æˆªå™¨çš„æ³¨å†Œå™¨ã€‚

éœ€è¦æ‹¦æˆªå“ªå†™è·¯å¾„ï¼ˆexcludeæ’é™¤ï¼‰ï¼ˆ...ä»£è¡¨å¯å˜å‚æ•°ï¼Œå¯ä»¥å¡«å†™å¤šä¸ªä¸åŒçš„å€¼ï¼‰

![idea64_6wXpEIL0rM.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_6wXpEIL0rM.png)

```java
@Configuration
public class MvcConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LoginInterceptor())
                .excludePathPatterns(
                        "/user/code",
                        "/user/login",
                        "/blog/hot",
                        "/shop/**",
                        "/shop-type/**",
                        "/upload/**",
                        "voucher/**"
                );
    }
}
```

#### è¿”å›ï¼ˆå·²ç™»å½•çŠ¶æ€ä¸‹ï¼‰ç”¨æˆ·è¯¦æƒ…ä¿¡æ¯

å›åˆ°UserControllerä¸­ï¼Œ

```java
@GetMapping("/me")
    public Result me(){
        // è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·å¹¶è¿”å›
        UserDTO user = UserHolder.getUser();
        return Result.ok(user);
    }
```

#### å°é—®é¢˜ï¼šéšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯

ä¸€èˆ¬æˆ‘ä»¬åªéœ€è¦è¿”å›ç”¨æˆ·idå’Œæ‰‹æœºå·å°±å¯ä»¥äº†ï¼Œå¹¶ä¸éœ€è¦è¿åŒæ›´éšç§ä¿¡æ¯ä¸€èµ·è¿”å›ã€‚è¿™æ˜¯æœ‰æ³„éœ²é£é™©çš„ã€‚ä½¿ç”¨`UserHolder.getUser`è¿‡äºç›´æ¥ç²—æš´ç®€å•ã€‚è€Œå®ƒæ˜¯ç”±æˆ‘ä»¬ç¼–å†™çš„æ‹¦æˆªå™¨ä¸­é€šè¿‡sessionè·å–çš„ä¿¡æ¯ï¼Œsessionå­˜çš„ä¿¡æ¯è¿‡å¤šï¼Œå› ä¸º**sessionæ˜¯tomcatçš„å†…å­˜ç©ºé—´**ï¼Œå¯¹æ•´ä¸ªæœåŠ¡æ¥è®²**å‹åŠ›ä¹Ÿè¶Šå¤§**ã€‚è€Œå­˜å…¥sessionä¿¡æ¯çš„**æºå¤´**æ˜¯æœ€åˆåšLoginç™»å½•åŠŸèƒ½æ—¶æš´éœ²çš„é—®é¢˜ğŸ‘‡

![idea64_93eqerXSEP.gif](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_93eqerXSEP.gif)

ç°åœ¨æˆ‘ä»¬è¦åšçš„æ˜¯ä¿®æ”¹æœ€åˆå¼€å§‹çš„**å­˜å‚¨åŠ›åº¦**ã€‚è¿™é‡Œæˆ‘ä»¬åœ¨dtoï¼ˆä¸“é—¨ç”¨æ¥ä¼ è¾“å®ä½“æ•°æ®çš„åŒ…ï¼‰åŒ…ä¸‹ä»…å½•å…¥åŸºæœ¬ä¿¡æ¯ã€‚

```java
@Data
public class UserDTO {
    private Long id;
    private String nickName;
    private String icon;
}
```

ç¬¨è›‹æ³•æ˜¯æ‰‹åŠ¨çš„å°†æŸ¥è¯¢åˆ°çš„userä¿¡æ¯ä¸€ä¸ªä¸€ä¸ªæ·»åŠ åˆ°æ–°newå‡ºæ¥çš„userDtoå¯¹è±¡ä¸­ã€‚ä½†è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°ä¸€ä¸ªå·¥å…·ç±»BeanUtilï¼ˆå®ƒä¹Ÿæ˜¯Hutoolé‡ŒåŒ…å«çš„å·¥å…·ç±»ï¼‰èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ‹·è´å±æ€§ã€‚

**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å…ˆå‰åœ¨å¯¹loginç™»å½•æ—¶åšçš„æ‹¦æˆªå™¨æ—¶ä¿å­˜åœ¨utilsåŒ…ä¸‹çš„ï¼Œè€Œæ’é™¤loginç­‰æ“ä½œåœ¨å¤–ï¼Œé…ç½®æ‹¦æˆªå™¨ï¼ˆnewä¸€ä¸ªæ‹¦æˆªå™¨å¯¹è±¡çš„æ„æ€ï¼ŒåŒæ—¶å¼€æ”¾æˆ–æ’é™¤å“ªå†™è·¯å¾„ï¼‰è¿™å®¶ä¼™æ‰æ˜¯æ”¾åœ¨configåŒ…ä¸‹çš„ï¼Œä¸è¦ææ··æ·†äº†ã€‚**

![idea64_gNS4BEj00k.gif](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/idea64_gNS4BEj00k.gif)

## é›†ç¾¤çš„sessionå…±äº«é—®é¢˜

æŒ‡**å¤šå°Tomcatæ— æ³•å…±äº«sessionå­˜å‚¨ç©ºé—´**ã€‚

![chrome_ghXUzHDXhb.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_ghXUzHDXhb.png)

å½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒtomcatæ—¶ï¼ŒåŸå…ˆå­˜å‚¨åœ¨ä¸€å°tomcatä¸­çš„sessionåœ¨å…¶ä»–çŒ«é‡Œæ—¶çœ‹ä¸åˆ°çš„ã€‚

è™½ç„¶æˆ‘ä»¬åšåˆ°è¿™ä¸ªç³»ç»Ÿæ˜¯ä¸€ä¸ªå•ä½“å¼æ¶æ„ï¼Œä½†æˆ‘ä»¬è¿™ä¸€å°çŒ«å°†æ¥ä¸ºäº†åº”å¯¹å¹¶å‘ï¼Œè‚¯å®šéœ€è¦åšæ°´å¹³æ‰©å±•â€”â€”éƒ¨ç½²å¤šä¸ªï¼Œ**å½¢æˆè´Ÿè½½å‡è¡¡çš„é›†ç¾¤**ã€‚

æ­¤æ—¶å½“è¯·æ±‚è¿›å…¥nginxï¼Œå®ƒä¼šåœ¨å¤šå°çŒ«ä¹‹é—´åšè½®è¯¢ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€å°çŒ«éƒ½ä¼šç”±è‡ªå·±çš„è´Ÿè½½ç©ºé—´ã€‚

#### è§£å†³æ–¹æ¡ˆï¼šè®©sessionå¯ä»¥å…±äº«

çŒ«æä¾›äº†sessionæ‹·è´çš„åŠŸèƒ½ï¼Œä½†æ•°æ®æ‹·è´ä¹Ÿæœ‰å‡ ä¸ªé—®é¢˜ï¼šå†…å­˜ç©ºé—´çš„æµªè´¹ï¼Œæ‹·è´æ•°æ®æœ‰å»¶è¿Ÿã€‚å› æ­¤è¯¥æ–¹æ¡ˆè¢«æ·˜æ±°äº†ã€‚

æ›¿ä»£æ–¹æ¡ˆå¿…é¡»æ»¡è¶³ï¼šï¼ˆredisï¼‰

- æ•°æ®å…±äº«

- å†…å­˜å­˜å‚¨ï¼ˆsessionæ˜¯åŸºäºå†…å­˜çš„ï¼Œè¯»å†™æ•ˆç‡é«˜ï¼‰

- key,valueç»“æ„ï¼ˆå› ä¸ºsessionå°±æ˜¯ä¸€ç§éå¸¸æ–¹ä¾¿çš„å­˜å–æ–¹æ¡ˆï¼‰

redisé¦–å…ˆæ˜¯åœ¨çŒ«ä»¥å¤–çš„å­˜å‚¨æ–¹æ¡ˆï¼Œ**å› æ­¤ä»»ä½•ä¸€å°çŒ«éƒ½èƒ½è®¿é—®åˆ°redis**ï¼Œå› æ­¤ä»»ä½•ä¸€å°çŒ«éƒ½èƒ½è®¿é—®åˆ°redisï¼Œç”±æ­¤å®ç°äº†**æ•°æ®å…±äº«**ï¼

å› æ­¤ï¼Œ**ç”¨redisæ›¿ä»£sessionæ˜¯åŠ¿åœ¨å¿…è¡Œçš„é€‰æ‹©äº†ã€‚**

## åŸºäºRediså®ç°å…±äº«sessionç™»å½•

ä¸šåŠ¡ä¸Šçš„å˜åŒ–ï¼šéªŒè¯ç ä¿å­˜åˆ°redisä¸­ï¼Œè€Œredisä¸­valueæœ‰å¾ˆå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚ï¼ˆstringå°±OKäº†ï¼‰ç¬¬äºŒä¸ªé—®é¢˜ï¼Œsessionçš„ç‰¹ç‚¹æ˜¯**æ¯ä¸€ä¸ªä¸åŒçš„æµè§ˆå™¨åœ¨å‘é€è¯·æ±‚æ—¶éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„session**ï¼ä¹Ÿå°±æ˜¯è¯´åœ¨tomcatå†…éƒ¨ç»´æŠ¤äº†å¾ˆå¤šçš„sessionã€‚

è€Œredisæ˜¯ä¸€ä¸ªå…±äº«çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤ä¸èƒ½éƒ½ç”¨codeä¸ºkeyã€‚å¿…é¡»ç¡®ä¿ä¸åŒç”¨æˆ·åšæ‰‹æœºå·éªŒè¯æ—¶keyéƒ½å¾—æ˜¯ä¸åŒçš„ã€‚äºæ˜¯æˆ‘ä»¬è½¬æ¢äº†ä¸€ä¸ªæ€è·¯ï¼šæ—¢ç„¶æ‹¥æœ‰å”¯ä¸€æ€§ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨æ‰‹æœºå·ä½œä¸ºkeyä¸å°±å¥½äº†å—ï¼Ÿ

è¿™æ ·åšä¸ä»…èƒ½ç¡®ä¿å”¯ä¸€æ€§ï¼Œè¿˜å¯ä»¥**æœ‰åŠ©äºå°†æ¥è·å–éªŒè¯ç å»éªŒè¯ã€‚**

ä¹‹å‰åŸºäºsessionç™»å½•æ—¶æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å–æ•°æ®çš„é—®é¢˜ï¼Œå› ä¸ºçŒ«ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç»´æŠ¤sessionã€‚å®é™…ä¸Šï¼Œ**åˆ›å»ºsessionæ—¶ä¼šè‡ªåŠ¨å½¢æˆsessionIDï¼Œå†™åˆ°ç”¨æˆ·æµè§ˆå™¨çš„Cookieé‡Œ**ï¼Œç”¨æˆ·ä¹‹åçš„æ¯æ¬¡è¯·æ±‚éƒ½ä¼šå¸¦ç€cookieï¼Œä¹Ÿå°±æ˜¯sessionID,è¿™æ ·å°±èƒ½å¾ˆå®¹æ˜“æ‰¾åˆ°sessionã€‚

ä½†ç°åœ¨ç”¨çš„redisï¼Œå¯æ¯æ—¥ä¼šå»å¸®ä½ ç»´æŠ¤idä»€ä¹ˆçš„ã€‚ä½ å¾—è‡ªå·±å–ã€‚ï¼ˆè¿™å°±æ˜¯è®¾è®¡çš„æŠ€å·§ï¼‰

#### ä¿å­˜å¯¹è±¡åº”è¯¥ç”¨åˆ°å“ªç§æ•°æ®ç±»å‹å‘¢ï¼Ÿ

åœ¨redisç§ä¿å­˜å•ä¸ªå¯¹è±¡æ—¶ï¼Œå¸¸è§æ–¹å¼æœ‰ä¸¤ç§ï¼š

1. stringç»“æ„
   
   **å°†javaå¯¹è±¡ï¼Œåºåˆ—æˆjsonå­—ç¬¦ä¸²**è¿›è¡Œä¿å­˜ã€‚
   
   å­—æ®µä¸å­—æ®µä¹‹é—´åˆæˆä¸€ä¸ªæ•´ä½“ã€‚

2. **Hashç»“æ„**
   
   å“ˆå¸Œç»“æ„çš„valueå¯ä»¥ç†è§£æˆmapï¼Œæ‹¥æœ‰keyï¼Œï¼ˆfield:nameå­—æ®µå’Œvalue:jackï¼‰ä¸¤å—å»ä¿å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´æ‹†å¼€äº†ã€‚å­—æ®µä¹‹é—´ç‹¬ç«‹åˆ†å¼€ï¼Œå¯ä»¥è¿›è¡Œç‹¬ç«‹æŸ¥è¯¢ã€‚å†…å­˜å ç”¨æ›´å°‘ï¼Œåªéœ€ä¿å­˜æ•°æ®æœ¬èº«ï¼Œæ²¡æœ‰:""ç­‰ç¬¦å·æ ¼å¼å ç”¨æ•°æ®å­˜å‚¨ã€‚

æˆ‘ä»¬ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ—¶ä¸å¤ªæ¨èå†ä½¿ç”¨æ‰‹æœºå·æ–¹å¼äº†ï¼Œ

è€Œæ˜¯**å»ºè®®ä½¿ç”¨éšæœºtokenä¸ºkeyå­˜å‚¨ç”¨æˆ·æ•°æ®**ã€‚ï¼ˆä¹Ÿå°±æ˜¯**éšæœºå­—ç¬¦ä¸²**ï¼Œå¯ä»¥ç”¨UUIDæ¥ç”Ÿæˆï¼‰ã€‚

ä»¥å‰ç™»å½•æ ¡éªŒé€šè¿‡sessionIDæ–¹å¼ï¼Œè€Œç°åœ¨çš„**ç™»é™†å‡­è¯å°±å˜æˆäº†token**ã€‚

æœ‰ä¸ªé—®é¢˜ï¼ŒtokençŒ«æ˜¯ä¸ä¼šå¸®æˆ‘ä»¬è‡ªå·±å†™åˆ°æµè§ˆå™¨ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½è‡ªå·±æ‰‹åŠ¨çš„å°†ç”Ÿæˆçš„tokenè¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆä¹Ÿå°±æ˜¯æµè§ˆå™¨ï¼‰

![chrome_LnrlMe4sCV.png](https://raw.githubusercontent.com/Fanyup/cloudimg/master/img/chrome_LnrlMe4sCV.png)

#### å°é—®é¢˜ï¼šå‰ç«¯æ˜¯å¦‚ä½•æ¯æ¬¡è®¿é—®è¯·æ±‚éƒ½æºå¸¦Tokençš„

å‰ç«¯vueæ²¡çœ‹æ‡‚ï¼Œæš‚æ—¶æ”¾ä¸€ä¸‹[è§†é¢‘](https://www.bilibili.com/video/BV1cr4y1671t?p=32&spm_id_from=pageDriver&vd_source=baf5a4288b31a243832175ddb5cbd481)

ç›´æ¥ç”¨æ‰‹æœºå·ä¼šæœ‰ä¿¡æ¯æ³„éœ²çš„é£é™©ã€‚ã€‘

#### æ–°æ”¹åŠ¨

åœ¨æœåŠ¡å®ç°ç±»ä¸­ï¼Œé€šè¿‡`@Resource`æ³¨è§£ï¼Œæ³¨å…¥SpringRedisTemplateæä¾›çš„apiã€‚
